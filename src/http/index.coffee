{ Duplex } = require 'stream'
{ createServer } = require 'http'
{ readFileSync, existsSync, statSync } = require 'fs'

path = require 'path'

file = require './file'
route = require './router'
args = require '../args'
cwmp = require './cwmp'

module.exports = (ip, port) ->

  if args.sts
    try
      file.custom = readFileSync args.sts
    catch e
      throw e

  route
    .get '/file.sts', (req, res) ->
      console.log '>>> STS REQUEST'

      f = file.custom or file.sts

      headers =
        'Content-Type': 'text/plain'
        'Content-Length': f.length

      console.log '>>> STS RESPONSE'
      console.dir [headers, f.toString('utf8')]

      res.writeHead 200, headers

      stream = new Duplex()
      stream.push f
      stream.push null
      stream.pipe res
    .get '/done', (req, res) ->
      console.log '>>> WPS CALLBACK'
      console.log """\n
        All done,

        - change network card settings back to dhcp and move the cable back to a lan port
        - try ssh connection to the gateways ip (usually 192.168.0.1) with username root and password root (change password immediately with passwd!)

        ssh root@192.168.0.1"""

      setTimeout ->
        process.exit 1
      , 20000

      res.writeHead 200
      res.end()
    .get '/{rbi}(.*?).rbi', (req, res) ->
      console.log '>>> RBI REQUEST'

      fp = path.join process.cwd(), req.params.rbi, '.rbi'

      if existsSync fp
        stats = statSync fp

        headers =
          'Content-Type': 'text/plain'
          'Content-Length': stats.size

        stream = createReadStream fp

        console.log '>>> RBI RESPONSE'
        console.dir [headers, fp]

        res.writeHead 200, headers
        stream.pipe res
      else
        res.writeHead 404

    .post '/', cwmp(ip + ':' + port)

  srv = createServer route
  srv.keepAliveTimeout = 30000

  srv.listen port, ip
