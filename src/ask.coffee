{ networkInterfaces } = require 'os'

ips = require './ips'

readline = require 'readline'
  .createInterface
    input: process.stdin
    output: process.stdout

module.exports = (ip) ->
  interval = null

  addr = []

  check = ->
    addr = ips()

    addr.find ({ address }) -> address is ip

  p = new Promise (resolve, reject) ->

    ask = ->
      add = check()

      if add then return resolve add

      console.log "Could not find interface with ip: #{ ip }"
      console.table addr

      readline.question "Select network interface: ", (idx) ->
        if not addr[idx]?
          console.log 'Unknown index: ' + idx
          return ask()

        if addr[idx].address isnt ip
          return ask()

        resolve addr[idx]

    interval = setInterval ->
      add = check()

      if add then resolve add
    , 2000

    ask()

  p.then (add) ->
    console.log "using interface", add

    clearInterval interval
    readline.close()

  p
